# 消息转发服务器Demo项目

## 📊 系统架构总览

### 三层架构设计
```
┌─────────────────┐
│   客户端连接层    │  ← 网络I/O、连接管理
├─────────────────┤
│   业务逻辑层     │  ← 消息路由、会话管理
├─────────────────┤
│   数据持久层     │  ← 用户数据、消息历史
└─────────────────┘
```

## 🏗️ 已实现的模块及其功能

### 1. **主控制模块** (`server.c/server.h`)
**核心职责**：程序入口、全局资源管理、主循环控制

**实现功能**：
- 服务启动/停止流程控制
- 全局配置管理（端口、超时等参数）
- 信号处理（优雅关闭）
- 各子系统初始化与协调

### 2. **数据模型层** (`models/`)
**功能说明**：
- **`models.h`**：定义所有核心数据结构
  - `Client`：客户端连接状态、认证信息
  - `Message`：消息内容、路由信息、状态
  - `User`：用户账户信息、权限状态
  - `Group`：群组配置、成员管理
  - `ServerConfig`：运行时配置参数

- **`user.h/c`**：用户数据管理
  - 用户认证（用户名/密码验证）
  - 用户状态维护（在线/离线）
  - 用户信息查询与更新
  - 用户数据持久化到文件

### 3. **核心业务层** (`core/`)
**功能说明**：

- **`connection_manager`**：连接生命周期管理
  - 新客户端接入登记
  - 连接断开资源清理
  - 客户端查找（按socket或用户名）
  - 在线状态监控

- **`message_router`**：消息分发策略
  - 一对一消息精确转发
  - 群组消息广播分发
  - 全局广播消息处理
  - 消息路由策略判断

- **`session_manager`**：用户会话管理
  - 登录/登出流程处理
  - 会话状态验证
  - 会话超时检测与处理
  - 活动时间更新

### 4. **协议处理层** (`protocol/`)
**功能说明**：

- **`parser`**：协议解析
  - 原始报文解析为结构化数据
  - 登录消息解析（用户名/密码提取）
  - 聊天消息解析（发送者/接收者/内容）
  - 协议格式验证与错误处理

- **`builder`**：响应构建
  - 标准化响应生成
  - 聊天消息格式化
  - 错误信息封装

- **`command_handler`**：命令分发执行
  - 命令类型识别与分发
  - 登录认证处理
  - 聊天消息转发触发
  - 历史查询处理

### 5. **网络通信层** (`network/`)
**功能说明**：

- **`tcp_server`**：TCP服务基础
  - 套接字创建与绑定
  - 监听端口管理
  - 客户端连接接受
  - 连接关闭处理

- **`event_loop`**：事件驱动循环
  - select多路复用实现
  - 事件注册与注销
  - I/O就绪事件分发
  - 超时事件处理

- **`client_handler`**：客户端I/O处理
  - 数据读取与缓冲
  - 数据发送管理
  - 连接健康检查
  - 心跳包维护

### 6. **数据持久层** (`storage/`)
**功能说明**：

- **`history_manager`**：消息历史管理
  - 消息存储（私聊/群聊/广播）
  - 历史查询（按用户、群组、时间）
  - 消息状态更新（送达/已读）
  - 历史数据清理（旧数据归档）

- **`user_store`**：用户数据持久化
  - 用户账户文件读写
  - 用户信息增删改查
  - 数据文件格式维护
  - 数据一致性保证

### 7. **工具支持层** (`utils/`)
**功能说明**：

- **`logger`**：分级日志系统
  - 调试/信息/警告/错误分级
  - 控制台与文件双输出
  - 日志级别动态调整
  - 结构化日志格式

- **`time_utils`**：时间处理工具
  - 时间戳生成与格式化
  - 时间间隔计算
  - 时区处理
  - 时间比较判断

- **`safe_utils`**：安全编程工具
  - 安全字符串操作
  - 内存安全分配释放
  - 输入数据验证
  - 缓冲区溢出防护

## 🔄 数据流程说明

### 消息处理全流程
```
客户端连接 → 身份认证 → 消息接收 → 协议解析 →
命令处理 → 消息路由 → 目标查找 → 消息转发 →
历史存储 → 状态更新
```

### 用户状态管理流程
```
连接建立 → 登录请求 → 凭证验证 → 会话创建 →
状态登记 → 活动跟踪 → 超时检测 → 会话清理 →
连接关闭
```

## ⚙️ 系统特性说明

### 已实现的核心特性
1. **多客户端并发支持**：基于select的事件驱动
2. **完整认证机制**：用户名密码验证
3. **消息可靠传输**：TCP保证 + 状态跟踪
4. **历史记录完整**：所有消息自动保存
5. **资源管理规范**：连接、内存、文件描述符

### 消息类型支持
- **私聊消息**：点对点精确转发
- **群组消息**：组内成员广播
- **系统广播**：全服通知
- **历史查询**：按条件检索

### 数据持久化策略
- **用户数据**：启动时加载，退出时保存
- **消息历史**：实时追加，定期归档
- **运行日志**：按日期分割，大小限制

## 📈 性能与资源管理

### 资源使用规范
- **连接数限制**：可配置的最大并发
- **内存管理**：动态分配 + 及时释放
- **文件描述符**：合理复用，避免泄漏
- **CPU使用**：事件驱动避免忙等待

### 故障容错机制
- **连接异常处理**：断线检测与清理
- **数据完整性**：文件写入原子性保证
- **资源回收**：进程退出时完全清理
- **错误隔离**：单个客户端故障不影响整体

## 🎯 使用场景适配

### 适用场景
1. **小型团队通讯**：10-100人规模
2. **教学演示环境**：网络编程示例
3. **原型系统验证**：消息转发逻辑验证
4. **嵌入式环境**：资源受限的通讯需求

### 配置灵活性
- 端口号可配置
- 最大连接数可调整
- 超时参数可设置
- 日志级别可动态修改
