# 消息转发服务器 Demo 项目完整功能描述

## 🎯 项目概述

我要开发一个基于 TCP 协议的**纯文本消息转发服务器 Demo**，实现多客户端之间的实时通信。该项目采用 C 语言编写，遵循模块化工程架构，支持一对一私聊、多人群聊和广播消息，包含完整的用户认证系统和消息历史记录功能。

## 📋 核心功能规格

### 1. 用户系统

- **注册与登录**：客户端通过`LOGIN|用户名|密码`格式进行认证
- **状态管理**：服务器维护用户的在线/离线状态
- **唯一标识**：每个用户分配唯一 ID，支持按用户名和 ID 查找
- **会话保持**：登录后保持连接直至主动登出或断开

### 2. 消息通信模式

#### 一对一私聊

```
格式：MSG|接收者用户名|消息内容
示例：alice发送"MSG|bob|你好，在吗？"
转发：服务器准确转发给bob的客户端连接
```

#### 群组聊天

```
创建群组：CREATE_GROUP|群组名|成员列表
加入群组：JOIN_GROUP|群组名
群组消息：GROUP_MSG|群组名|消息内容
效果：消息发送给群组所有在线成员
```

#### 广播消息

```
格式：BROADCAST|消息内容
效果：所有在线用户都会收到此消息
```

### 3. 历史记录系统

- **自动存储**：所有类型消息（私聊、群聊、广播）自动保存
- **灵活查询**：
  - `HISTORY_PRIVATE|对方用户名|数量`：查询私聊历史
  - `HISTORY_GROUP|群组名|数量`：查询群聊历史
  - `HISTORY_RECENT|数量`：查询最近消息
- **消息状态**：支持已发送、已送达状态追踪

### 4. 客户端功能

- **多连接管理**：可同时与多个用户/群组通信
- **在线列表**：实时显示在线用户状态
- **消息通知**：新消息到达提醒
- **历史查看**：可浏览和搜索历史对话
- **断线重连**：支持自动重连和离线消息接收

## 🏗️ 系统架构

### 技术栈

- **传输协议**：TCP（保证可靠传输）
- **应用协议**：自定义文本协议（`|`分隔字段）
- **并发模型**：I/O 多路复用（select/poll）
- **数据存储**：文件系统存储（用户数据、消息历史）
- **工程结构**：模块化设计，分离模型、网络、业务逻辑

### 目录结构

```
message_forward_server/
├── models/           # 数据模型定义
│   ├── models.h     # 核心结构体定义
│   ├── user.h/c     # 用户管理接口
├── core/            # 业务逻辑核心
│   ├── connection_manager.c   # 连接管理
│   ├── message_router.c       # 消息路由
│   └── session_manager.c      # 会话管理
├── protocol/        # 协议处理
│   ├── parser.c     # 消息解析
│   ├── builder.c    # 消息构建
│   └── handler.c    # 命令处理
├── storage/         # 数据存储
│   ├── history_manager.c      # 历史管理
│   └── user_store.c           # 用户数据
├── network/         # 网络层
│   ├── tcp_server.c           # TCP服务器
│   └── event_loop.c           # 事件循环
└── utils/           # 工具函数
```

## 🔄 完整消息流程

### 连接与认证阶段

1. 客户端建立 TCP 连接到服务器端口（默认 6666）
2. 发送登录请求：`LOGIN|alice|123456`
3. 服务器验证凭证，返回：`AUTH_OK|欢迎alice` 或 `AUTH_FAIL|认证失败`
4. 认证成功后，用户状态设为在线

### 消息转发阶段

1. 客户端 A 发送：`MSG|bob|项目进展如何？`
2. 服务器解析消息，验证 bob 是否在线
3. 将消息存储到历史记录
4. 查找 bob 的客户端连接
5. 转发消息给 bob：`MSG|alice|项目进展如何？`
6. bob 客户端收到并显示消息

### 历史查询阶段

1. 客户端发送：`HISTORY_PRIVATE|bob|10`
2. 服务器查询与 bob 最近 10 条私聊记录
3. 按时间顺序返回消息列表
4. 客户端展示历史对话

## 📊 数据存储设计

### 用户数据文件 (users.dat)

```
格式：用户名|密码|用户ID|注册时间戳|激活状态
示例：alice|123456|1001|1629091200|1
       bob|654321|1002|1629091300|1
```

### 消息历史文件 (messages.dat)

```
格式：消息ID|类型|发送者|接收者|时间戳|内容|状态
示例：5001|MSG|alice|bob|1629091400|你好|DELIVERED
      5002|GROUP_MSG|alice|tech_group|1629091500|会议开始|SENT
```

### 群组数据文件 (groups.dat)

```
格式：群组ID|群组名|创建者|创建时间|成员列表
示例：2001|tech_team|alice|1629091200|alice,bob,charlie
```

## 🎮 使用场景示例

### 场景 1：团队协作

1. alice 创建技术群组：`CREATE_GROUP|tech_team|alice,bob,charlie`
2. 在群组中讨论：`GROUP_MSG|tech_team|新版API文档已更新`
3. bob 和 charlie 实时收到群消息
4. 下班后，david 查询群历史：`HISTORY_GROUP|tech_team|50`

### 场景 2：客户支持

1. 客户连接并认证
2. 发送问题：`MSG|support|订单无法支付`
3. 客服人员实时收到问题
4. 回复客户：`MSG|customer|请检查支付方式`
5. 完整对话保存到历史

## ✅ 验收标准

### 基本功能

- [ ] 支持至少 10 个并发客户端连接
- [ ] 实现用户登录/登出流程
- [ ] 一对一私聊消息准确转发
- [ ] 群组消息发送给所有成员
- [ ] 广播消息发送给所有在线用户
- [ ] 消息历史可查询和浏览

### 可靠性

- [ ] 无消息丢失或重复
- [ ] 服务器重启后数据不丢失
- [ ] 客户端断线自动清理资源
- [ ] 支持离线消息暂存（可选）

### 性能要求

- [ ] 消息端到端延迟 < 100ms（局域网）
- [ ] 支持每秒处理 100+消息
- [ ] 内存使用稳定，无泄漏
- [ ] 支持 7x24 小时持续运行

## 🔧 开发计划

### Phase 1：基础框架（2 天）

- TCP 服务器搭建
- 多客户端连接管理
- 基础消息解析

### Phase 2：核心功能（3 天）

- 用户认证系统
- 一对一消息转发
- 基础历史存储

### Phase 3：高级功能（2 天）

- 群组聊天系统
- 广播功能
- 历史查询接口

### Phase 4：优化完善（1 天）

- 错误处理与日志
- 性能优化
- 文档整理

## 📝 技术特点

1. **纯 C 实现**：无外部框架依赖，便于理解和移植
2. **工程化架构**：模块清晰，职责分离，便于维护扩展
3. **跨平台设计**：通过条件编译支持 Linux/macOS/Windows
4. **协议简洁**：文本协议易于调试和测试
5. **存储轻量**：文件存储满足 Demo 需求，易于扩展为数据库

这是一个**完整可实施的聊天服务器 Demo 项目**，涵盖了从网络通信到业务逻辑的全栈功能，适合作为学习网络编程和系统设计的实践项目。

## 📁 完整工程结构

```
message_forward_server_demo/
├── README.md                    # 项目说明文档
├── Makefile                     # 编译管理
├── server.c                     # 服务器主程序入口
├── server.h                     # 服务器主头文件
│
├── models/                      # 数据模型定义
│   ├── models.h                 # 核心结构体定义
│   ├── user.h                   # 用户管理接口
│   └── user.c                   # 用户管理实现
│
├── core/                        # 核心业务逻辑
│   ├── core.h                   # 核心模块头文件
│   ├── connection_manager.c     # 连接管理（客户端增删查）
│   ├── message_router.c         # 消息路由（一对一/广播/群发）
│   └── session_manager.c        # 会话管理（认证/状态）
│
├── protocol/                    # 协议处理模块
│   ├── protocol.h               # 协议模块头文件
│   ├── parser.c                 # 消息解析（字符串↔结构体）
│   ├── builder.c                # 消息构建（结构体→字符串）
│   └── command_handler.c        # 命令处理（LOGIN/MSG等）
│
├── storage/                     # 数据存储模块
│   ├── storage.h                # 存储模块头文件
│   ├── history_manager.c        # 历史消息存储与查询
│   └── user_store.c             # 用户数据管理
│
├── network/                     # 网络层模块
│   ├── network.h                # 网络模块头文件
│   ├── tcp_server.c             # TCP服务器封装
│   ├── event_loop.c             # 事件循环（select/poll）
│   └── client_handler.c         # 客户端数据读取/发送
│
├── utils/                       # 工具模块
│   ├── utils.h                  # 工具模块头文件
│   ├── logger.c                 # 日志输出
│   ├── safe_utils.c             # 安全函数（字符串处理等）
│   └── time_utils.c             # 时间戳生成
│
└── tests/                       # 测试目录（可选）
    ├── test_client.c            # 模拟客户端用于测试
    └── test_protocol.c          # 协议解析测试
```
